generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  role      Role     @default(BEGELEIDER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Youth {
  id        String   @id @default(uuid())
  firstName String
  lastName  String   // Only visible to authorized roles
  groupId   String?
  group     Group?   @relation(fields: [groupId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  mutations   SportMutation[]
  indications SportIndication[]
  incidents   Incident[]
}

model Group {
  id                String   @id @default(uuid())
  name              String   @unique
  color             GroupColor? @default(GROEN) // Updated to Enum
  department        String?
  isActive          Boolean  @default(true)
  status            GroupStatus @default(ACTIVE)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  reports           Report[]
  // sessions          SportSession[] // Deprecated in favor of Report
  extraSportMoments ExtraSportMoment[]
  youths            Youth[]
  notes             Note[]   // Relation to Note model
  restorativeTalks  RestorativeTalk[] // New standalone talks
  
  // Master Spec additions
  youthCount  Int      @default(0)
  
  // Medical Extensions
  mutations     SportMutation[]
  indications   SportIndication[]
  materialUsage MaterialUsage[]
  incidents     Incident[]
}

model Note {
  id        String   @id @default(uuid())
  content   String
  groupId   String
  group     Group    @relation(fields: [groupId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  authorId  String?
  archived  Boolean  @default(false)
}

model RestorativeTalk {
  id            String                  @id @default(uuid())
  groupId       String
  group         Group                   @relation(fields: [groupId], references: [id])
  
  youthName     String                  // Manually entered name
  reason        String?                 // Reason for the talk
  status        RestorativeTalkStatus   @default(PENDING)
  failureReason String?                 // Only if status = FAILED
  
  createdAt     DateTime                @default(now())
  createdBy     String?                 // User ID
  completedAt   DateTime?
  archivedAt    DateTime?
  archived      Boolean                 @default(false)
}

model Report {
  id          String     @id @default(uuid())
  date        DateTime   @default(now()) // sessionDate
  
  groupId     String
  group       Group      @relation(fields: [groupId], references: [id])
  
  type        ReportType @default(SESSION)
  
  // New Structured Data
  presentYouth    Int      @default(0)
  mood            String?
  sessionSummary  String?
  interventions   String?  // Stored as JSON string in SQLite
  incidents       String?  // Stored as JSON string in SQLite
  injuries        String?  // Stored as JSON string in SQLite
  planForTomorrow String?
  
  // JJI Quick-Input Fields
  youthCount      Int      @default(0)  // Number of youths (with +/- buttons)
  leaderCount     Int      @default(0)  // Number of group leaders (GL)
  warmingUp       String?              // Warming-up description
  activity        String?              // Main activity/sportmoment description
  
  rawText         String?  // Original pasted text
  cleanedText     String?  // Privacy filtered text / Bijzonderheden
  parsedData      String?  // AI analysis result (JSON)
  parsedAt        DateTime?
  parsedBy        String?
  confidenceScore Float?
  
  author      String?    // Legacy
  authorId    String?    // Link to User
  
  isIncident  Boolean    @default(false)
  
  // Medical Extensions
  indicationId    String?
  indication      SportIndication? @relation(fields: [indicationId], references: [id])
  materialUsage   MaterialUsage[]
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  archived    Boolean    @default(false)
}

model Incident {
  id          String   @id @default(uuid())
  date        DateTime @default(now())
  groupId     String?
  group       Group?   @relation(fields: [groupId], references: [id])
  youthId     String?
  youth       Youth?   @relation(fields: [youthId], references: [id])
  
  description String
  alarmPressed Boolean @default(false)
  afterCare   String?
  
  authorId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model DailySummary {
  id          String   @id @default(uuid())
  date        DateTime @unique // EÃ©n samenvatting per dag
  content     String   // Gegenereerde HTML/Markdown van alle rapportages
  generatedAt DateTime @default(now())
  sentTo      String?  // Email adressen waarnaar verzonden
}

model AuditLog {
  id          String   @id @default(uuid())
  action      String   // CREATE, UPDATE, DELETE
  entity      String   // Group, Report, etc.
  entityId    String
  authorId    String?
  details     String?  // JSON string met wijzigingen
  timestamp   DateTime @default(now())
}

model ExtraSportMoment {
  id        String   @id @default(uuid())
  date      DateTime
  groupId   String
  group     Group    @relation(fields: [groupId], references: [id])
  createdAt DateTime @default(now())

  status    String   @default("PENDING") // PENDING, COMPLETED, REFUSED
  @@unique([groupId, date]) // One checkmark per group per day
}

model Program {
  id          String   @id @default(uuid())
  title       String
  description String?
  type        String   // TRAINING, NUTRITION
  content     String   // JSON or Text content of the program
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Document {
  id          String   @id @default(uuid())
  title       String
  category    String?  // PROTOCOL, PLAN, ETC
  url         String   // Path or URL to file
  createdAt   DateTime @default(now())
}

model SportMutation {
  id          String             @id @default(uuid())
  youthId     String
  youth       Youth              @relation(fields: [youthId], references: [id])
  groupId     String
  group       Group              @relation(fields: [groupId], references: [id])
  
  reason      String
  reasonType  MutationReasonType
  
  startDate   DateTime
  endDate     DateTime?          // Null = tot nader order
  isActive    Boolean            @default(true)
  
  createdBy   String             // User ID
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
}

model SportIndication {
  id          String          @id @default(uuid())
  youthId     String
  youth       Youth           @relation(fields: [youthId], references: [id])
  groupId     String
  group       Group           @relation(fields: [groupId], references: [id])
  
  // Basic info
  description String
  type        IndicationType
  issuedBy    String          // e.g. "Medische Dienst", "GW"
  
  // Additional medical service fields
  leefgroep            String?         // Living group
  responsiblePersons   String?         // e.g. "Orlando, Sebastiaan, Tim"
  feedbackTo           String?         // Who to report progress to
  canCombineWithGroup  Boolean         @default(true)
  guidanceTips         String?         // Beleggingstips
  learningGoals        String?         // Leerdoelen
  
  // Validity
  validFrom   DateTime
  validUntil  DateTime?
  isActive    Boolean         @default(true)
  
  // Pause functionality
  isPaused    Boolean         @default(false)
  pausedAt    DateTime?
  pauseReason String?
  
  // Archive functionality
  archived    Boolean         @default(false)
  archivedAt  DateTime?
  
  // Evaluations stored as JSON
  evaluations Json?           @default("[]")
  
  reports     Report[]
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

enum Role {
  SPORTDOCENT
  BEGELEIDER
  GROEPSLEIDER
  AV_MT
  BEHEERDER
}

enum GroupStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum ReportType {
  WARMING_UP
  SESSION
  BEHAVIOR
  INCIDENT
  GENERAL
}

enum GroupColor {
  GROEN
  GEEL
  ORANJE
  ROOD
}

enum MutationReasonType {
  MEDISCH
  GEDRAG
  BLESSURE
  OVERIG
}

enum RestorativeTalkStatus {
  PENDING
  COMPLETED
  FAILED
}

enum IndicationType {
  CARDIO
  KRACHT
  REVALIDATIE
  MEDISCH
  GEDRAG
  OVERIG
}

enum MaterialCategory {
  FITNESS
  BALLEN
  MATTEN
  ELASTIEKEN
  OVERIG
}

enum ConditionStatus {
  GOED
  LICHT_BESCHADIGD
  KAPOT
  TE_VERVANGEN
}

model Material {
  id              String          @id @default(uuid())
  name            String
  category        MaterialCategory
  description     String?
  quantityTotal   Int             @default(0)
  quantityUsable  Int             @default(0)
  location        String
  conditionStatus ConditionStatus @default(GOED)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  usage           MaterialUsage[]
}

model MaterialUsage {
  id           String   @id @default(uuid())
  materialId   String
  material     Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  date         DateTime @default(now())
  groupId      String?
  group        Group?   @relation(fields: [groupId], references: [id])
  reportId     String?
  report       Report?  @relation(fields: [reportId], references: [id])
  quantityUsed Int
  notes        String?
  createdBy    String
  createdAt    DateTime @default(now())
}

// --- Library Module ---

model Book {
  id          String   @id @default(uuid())
  title       String
  author      String
  isbn        String?
  coverUrl    String?
  totalCopies Int      @default(1)
  available   Int      @default(1)
  location    String?  // e.g. "Kast A"
  
  loans       Loan[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Loan {
  id          String    @id @default(uuid())
  bookId      String
  book        Book      @relation(fields: [bookId], references: [id])
  
  youthId     String?   // Optional link to Youth
  youthName   String    // Fallback name if not linked
  
  loanedBy    String    // User ID (Staff)
  loanDate    DateTime  @default(now())
  dueDate     DateTime?
  returnDate  DateTime?
  
  status      LoanStatus @default(ACTIVE)
  notes       String?
}

enum LoanStatus {
  ACTIVE
  RETURNED
  OVERDUE
  LOST
}

// --- Reservations Module ---

model Reservation {
  id          String    @id @default(uuid())
  resourceId  String    // ID of the resource (e.g. "SPORTZAAL", "FITNESS")
  resourceName String   // Display name
  
  userId      String    // Staff ID
  userName    String    // Staff Name
  
  startTime   DateTime
  endTime     DateTime
  
  title       String?   // Purpose
  description String?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}
