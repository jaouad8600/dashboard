generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(uuid())
  username    String   @unique // Changed from name to username for login
  name        String   // Display name
  email       String?  @unique // Optional now, username is primary
  password    String   // Hashed password
  role        Role     @default(SPORTBEGELEIDER)
  isActive    Boolean  @default(true)
  permissions String?  // JSON string for granular permissions
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum Role {
  BEHEERDER         // ADMIN
  SPORTBEGELEIDER
  GROEPSLEIDING
  TEAMLEIDER
  SPORTDOCENT
  BEGELEIDER
  GROEPSLEIDER
  AV_MT
}

model Youth {
  id        String   @id @default(uuid())
  firstName String
  lastName  String   // Only visible to authorized roles
  groupId   String?
  group     Group?   @relation(fields: [groupId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  mutations   SportMutation[]
  indications SportIndication[]
  incidents   Incident[]
  restrictions Restriction[]
  reports      Report[]
}

model Group {
  id                String   @id @default(uuid())
  name              String   @unique
  color             GroupColor? @default(GROEN) // Updated to Enum
  department        String?
  isActive          Boolean  @default(true)
  status            GroupStatus @default(ACTIVE)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  reports           Report[]
  // sessions          SportSession[] // Deprecated in favor of Report
  extraSportMoments ExtraSportMoment[]
  youths            Youth[]
  notes             Note[]   // Relation to Note model
  weekNotes         WeekNote[] // Relation to WeekNote model
  restorativeTalks  RestorativeTalk[] // New standalone talks
  
  // Master Spec additions
  youthCount  Int      @default(0)
  
  // Medical Extensions
  mutations     SportMutation[]
  indications   SportIndication[]
  materialUsage MaterialUsage[]
  incidents     Incident[]
  restrictions  Restriction[]
  loans         Loan[]
  reservations  Reservation[]
}

model Note {
  id        String   @id @default(uuid())
  content   String
  groupId   String
  group     Group    @relation(fields: [groupId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  authorId  String?
  archived  Boolean  @default(false)
}

model RestorativeTalk {
  id            String                  @id @default(uuid())
  groupId       String
  group         Group                   @relation(fields: [groupId], references: [id])
  
  youthName     String                  // Manually entered name
  reason        String?                 // Reason for the talk
  status        RestorativeTalkStatus   @default(PENDING)
  failureReason String?                 // Only if status = FAILED
  
  createdAt     DateTime                @default(now())
  createdBy     String?                 // User ID
  completedAt   DateTime?
  archivedAt    DateTime?
  archived      Boolean                 @default(false)
  
  evaluations   Evaluation[]            // Evaluations for this talk
}

model Report {
  id          String     @id @default(uuid())
  date        DateTime   @default(now()) // sessionDate
  
  groupId     String
  group       Group      @relation(fields: [groupId], references: [id])
  
  type        ReportType @default(SESSION)
  
  // New Structured Data
  presentYouth    Int      @default(0)
  mood            String?
  sessionSummary  String?
  interventions   String?  // Stored as JSON string in SQLite
  incidents       String?  // Stored as JSON string in SQLite
  injuries        String?  // Stored as JSON string in SQLite
  planForTomorrow String?
  
  // JJI Quick-Input Fields
  youthCount      Int      @default(0)  // Number of youths (with +/- buttons)
  leaderCount     Int      @default(0)  // Number of group leaders (GL)
  warmingUp       String?              // Warming-up description
  activity        String?              // Main activity/sportmoment description
  
  rawText         String?  // Original pasted text
  cleanedText     String?  // Privacy filtered text / Bijzonderheden
  parsedData      String?  // AI analysis result (JSON)
  parsedAt        DateTime?
  parsedBy        String?
  confidenceScore Float?
  
  author      String?    // Legacy
  authorId    String?    // Link to User
  
  isIncident  Boolean    @default(false)
  
  // Medical Extensions
  indicationId    String?
  indication      SportIndication? @relation(fields: [indicationId], references: [id])
  
  restrictionId   String?
  restriction     Restriction?     @relation(fields: [restrictionId], references: [id])
  
  youthId         String?
  youth           Youth?           @relation(fields: [youthId], references: [id])
  
  materialUsage   MaterialUsage[]
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  archived    Boolean    @default(false)
}

model Incident {
  id          String   @id @default(uuid())
  date        DateTime @default(now())
  groupId     String?
  group       Group?   @relation(fields: [groupId], references: [id])
  youthId     String?
  youth       Youth?   @relation(fields: [youthId], references: [id])
  
  description String
  alarmPressed Boolean @default(false)
  afterCare   String?

  // New fields
  staffShare        String? // Wat was het aandeel van de GL?
  deescalation      String? // Hoe is er uiteindelijk gedeëscaleerd?
  returnProcess     String? // Hoe is de terugverplaatsing verlopen?
  debriefing        String? // Is de situatie nabesproken met de betrokken GL?
  restorativeAction String? // Is een herstel wenselijk en zo ja, is hiervoor een lijntje gelegd met de GL?
  teamLeaderContact String? // Contact met eigen teamleider?
  
  authorId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model DailySummary {
  id          String   @id @default(uuid())
  date        DateTime @unique // Eén samenvatting per dag
  content     String   // Gegenereerde HTML/Markdown van alle rapportages
  generatedAt DateTime @default(now())
  sentTo      String?  // Email adressen waarnaar verzonden
}

model AuditLog {
  id          String   @id @default(uuid())
  action      String   // CREATE, UPDATE, DELETE
  entity      String   // Group, Report, etc.
  entityId    String
  authorId    String?
  details     String?  // JSON string met wijzigingen
  timestamp   DateTime @default(now())
}

model ExtraSportMoment {
  id        String   @id @default(uuid())
  date      DateTime
  groupId   String
  group     Group    @relation(fields: [groupId], references: [id])
  createdAt DateTime @default(now())

  status    String   @default("PENDING") // PENDING, COMPLETED, REFUSED
  @@unique([groupId, date]) // One checkmark per group per day
}

model Program {
  id          String   @id @default(uuid())
  title       String
  description String?
  type        String   // TRAINING, NUTRITION
  content     String   // JSON or Text content of the program
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Document {
  id          String   @id @default(uuid())
  title       String
  category    String?  // PROTOCOL, PLAN, ETC
  url         String   // Path or URL to file
  createdAt   DateTime @default(now())
}

model SportMutation {
  id          String             @id @default(uuid())
  youthId     String?            // Made optional for group-level mutations
  youth       Youth?             @relation(fields: [youthId], references: [id])
  groupId     String
  group       Group              @relation(fields: [groupId], references: [id])
  
  reason      String
  reasonType  MutationReasonType
  restriction String?            // "TOTAAL_SPORTVERBOD" | "ALLEEN_FITNESS"
  injuryDetails String?          // Specific injury details (e.g. "Broken hand")
  
  startDate   DateTime
  endDate     DateTime?          // Null = tot nader order
  isActive    Boolean            @default(true)
  
  createdBy   String             // User ID
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  
  // New boolean flags per user request
  totaalSportverbod Boolean      @default(false)
  alleenFitness     Boolean      @default(false)
}

model SportIndication {
  id          String          @id @default(uuid())
  youthId     String?         // Made optional for group-level indications
  youth       Youth?          @relation(fields: [youthId], references: [id])
  groupId     String
  group       Group           @relation(fields: [groupId], references: [id])
  
  // Basic info
  description String          // Summary or full text
  type        IndicationType
  issuedBy    String          // e.g. "Medische Dienst", "GW"
  
  // Additional medical service fields
  youthName            String?         // Fallback if youthId is null
  leefgroep            String?         // Living group
  activities           String?         // JSON or comma-separated list of activities
  advice               String?         // Advies/suggestie inhoud activiteit
  reasoning            String?         // Onderbouwing indicering
  responsiblePersons   String?         // e.g. "Orlando, Sebastiaan, Tim"
  feedbackTo           String?         // Who to report progress to
  canCombineWithGroup  Boolean         @default(true)
  guidanceTips         String?         // Beleggingstips
  learningGoals        String?         // Leerdoelen
  
  // Validity
  validFrom   DateTime
  validUntil  DateTime?
  isActive    Boolean         @default(true)
  
  // Pause functionality
  isPaused    Boolean         @default(false)
  pausedAt    DateTime?
  pauseReason String?
  
  // Archive functionality
  archived    Boolean         @default(false)
  archivedAt  DateTime?
  
  // Evaluations stored as JSON (Legacy)
  evaluationsJson Json?           @default("[]") @map("evaluations")
  
  // New relational evaluations
  evaluations     Evaluation[]
  
  reports     Report[]
  
  // Import metadata
  source      String?         // e.g. "outlook", "handmatig"
  receivedAt  DateTime?       // When it was received/imported

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}



enum GroupStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum ReportType {
  WARMING_UP
  SESSION
  BEHAVIOR
  INCIDENT
  GENERAL
  INDICATION
  RESTRICTION
}

enum GroupColor {
  GROEN
  GEEL
  ORANJE
  ROOD
}

enum MutationReasonType {
  MEDISCH
  GEDRAG
  BLESSURE
  OVERIG
}

enum RestorativeTalkStatus {
  PENDING
  COMPLETED
  FAILED
}

enum IndicationType {
  CARDIO
  KRACHT
  REVALIDATIE
  MEDISCH
  GEDRAG
  OVERIG
}

enum MaterialCategory {
  FITNESS
  BALLEN
  MATTEN
  ELASTIEKEN
  OVERIG
}

enum ConditionStatus {
  GOED
  LICHT_BESCHADIGD
  KAPOT
  TE_VERVANGEN
}

model Material {
  id              String          @id @default(uuid())
  name            String
  category        MaterialCategory
  description     String?
  quantityTotal   Int             @default(0)
  quantityUsable  Int             @default(0)
  location        String
  subLocation     String?         // e.g. "Fitness", "Sporthal", "Dojo"
  imageUrl        String?
  conditionStatus ConditionStatus @default(GOED)
  
  // New fields for detailed tracking
  quantityBroken  Int             @default(0)
  quantityToOrder Int             @default(0)
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  usage           MaterialUsage[]
}

model MaterialUsage {
  id           String   @id @default(uuid())
  materialId   String
  material     Material @relation(fields: [materialId], references: [id], onDelete: Cascade)
  date         DateTime @default(now())
  groupId      String?
  group        Group?   @relation(fields: [groupId], references: [id])
  reportId     String?
  report       Report?  @relation(fields: [reportId], references: [id])
  quantityUsed Int
  notes        String?
  createdBy    String
  createdAt    DateTime @default(now())
}

// --- Library Module ---

model Book {
  id          String   @id @default(uuid())
  title       String
  author      String
  isbn        String?
  coverUrl    String?
  totalCopies Int      @default(1)
  available   Int      @default(1)
  location    String?  // e.g. "Kast A"
  
  loans       Loan[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Loan {
  id          String    @id @default(uuid())
  bookId      String
  book        Book      @relation(fields: [bookId], references: [id])
  
  youthId     String?   // Optional link to Youth
  youthName   String    // Fallback name if not linked
  
  loanedBy    String    // User ID (Staff)
  loanDate    DateTime  @default(now())
  dueDate     DateTime?
  returnDate  DateTime?
  
  status      LoanStatus @default(ACTIVE)
  notes       String?
  
  // New fields for Library Planning
  groupId     String?
  group       Group?    @relation(fields: [groupId], references: [id])
  startTime   DateTime? // For specific timeslots
  endTime     DateTime?
}

enum LoanStatus {
  ACTIVE
  RETURNED
  OVERDUE
  LOST
}

// --- Reservations Module ---

model Reservation {
  id          String    @id @default(uuid())
  resourceId  String    // ID of the resource (e.g. "SPORTZAAL", "FITNESS")
  resourceName String   // Display name
  
  userId      String    // Staff ID
  userName    String    // Staff Name
  
  // New field for Group selection
  groupId     String?
  group       Group?    @relation(fields: [groupId], references: [id])
  
  startTime   DateTime
  endTime     DateTime
  
  title       String?   // Purpose
  description String?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Restriction {
  id          String    @id @default(uuid())
  youthId     String
  youth       Youth     @relation(fields: [youthId], references: [id])
  groupId     String
  group       Group     @relation(fields: [groupId], references: [id])
  
  reason      String
  startDate   DateTime
  endDate     DateTime?
  isActive    Boolean   @default(true)
  
  createdBy   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  reports     Report[]
}

model ChatMessage {
  id        String   @id @default(uuid())
  channel   String
  sender    String
  content   String
  createdAt DateTime @default(now())
}

model File {
  id        String   @id @default(uuid())
  name      String
  url       String
  type      String
  size      Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Evaluation {
  id                 String           @id @default(uuid())
  indicationId       String?
  indication         SportIndication? @relation(fields: [indicationId], references: [id], onDelete: Cascade)
  restorativeTalkId  String?
  restorativeTalk    RestorativeTalk? @relation(fields: [restorativeTalkId], references: [id], onDelete: Cascade)
  date               DateTime         @default(now())
  summary            String
  author             String?
  emailedAt          DateTime?        // Track when the evaluation was emailed
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
}

model PhoneNumber {
  id          String   @id @default(uuid())
  department  String   // Afdeling
  location    String   // Ruimte
  number      String   // Nummer
  description String?  // Omschrijving
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model WeekNote {
  id        String   @id @default(uuid())
  content   String
  date      DateTime @default(now())
  author    String
  groupId   String?
  group     Group?   @relation(fields: [groupId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
